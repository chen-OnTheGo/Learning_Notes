
在本单元中，我们开始讨论虚拟机的实现，而上一节已经完成了[the Stack](the%20Stack.md)的实现。在本节中，我们将继续实现内存段。

我们从一个与抽象的内存空间交互的stack开始了这段虚拟机之旅，接着，我们用八个内存段替换了这个抽象空间，它们分别为：`local`、`argument`、`this`、`that`、`constant`、`static`、`pointer`、`temp`。
![](../../../../../../img/Pasted%20image%2020250919220233.png)

现在的问题是，如何在host computer上实现这些Memory Segments。

在开始之前，我们可以看到，这些内存段的抽象非常统一，都是需要我们使用完全相同的语法（`push segment i`或`pop segment i`）来处理任何分段中的任何位置。那么我们该如何实现这些内存段？

一步一步地来，我们先实现`local`内存段，该如何在主机RAM上实现该内存段？
在上一节stack实现的基础上（从地址为256的位置开始stack，使用一个名为`SP`的指针来记录stack中下一个可用位置的地址，并将`SP`映射到host computer内存中的`RAM[0]`上），我们来实现`local Segment`。

原则上可用将`local Segment`放在RAM上我们想要的任何地方，只要我们能记住这个区块的基址（基本地址），就不用在乎`local Segment`将存储在哪里。

于是，我们决定将`local Segment`的基址放在名为`LCL`的指针中，并将`LCL`映射到`RAM[1]`上。

![](../../../../../../img/Pasted%20image%2020250924170213.png)

如图所示，我们有两个指针，其中`SP`指针指向stack中的下一个可用位置，`LCL`指向`local Segment`的基址。现在执行`pop local 2`，执行的过程会是什么样的呢？

首先我们可以看到`local segment`的基址为`1015`，偏移量（索引）为`2`，通过将基址与偏移量相加，我们得到存储弹出值的目标地址的值。
接着，将`SP`中的值减一，变成了图中右侧所示的`257`，这意味着，`RAM[257]`中的值（也就是`5`）失效了，若下次再往里面放入某个值，将直接把这里的`5`覆盖掉。

因此，当我们管理一个stack时，这个stack里面有各种各样的垃圾（残留的数据），这是很常见的。然而，stack中的指针又能准确地表示stack的哪一部分是有效区域（当前函数正在使用的区域），哪一部分是可以忽略或覆盖的无效数据。便于我们管理。

![](../../../../../../img/Pasted%20image%2020250924170534.png)

于是实现的步骤为：
```
addr = LCL+2
SP--
*addr = *SP
```

同理可得，`pop segment i`的实现步骤为：
```
addr = LCL+i
SP--
*addr = *SP
```

`push segment i`的实现步骤为：
```
addr = LCL+i
*SP = *addr
SP++
```


现在让我们扩展一下，一起谈谈`local`、`argument`、`this`、`that`这四个部分，thinking一下这些Segments来自哪里，或者说它们有什么用处？

![](../../../../../../img/Pasted%20image%2020250924221110.png)

在现实中，比如说Java方法调用，一个方法在运行时往往会用到局部变量（local variables）、参数变量（argument variables）、当前对象的成员变量/字段（this指向的对象的属性）、数组或其他数据结构（可能由that指针引用）。

当我们将这些逻辑抽象成虚拟机模型时，虚拟机也必须能表达出这些语义，因此，我们使用`local`、`argument`、`this`、`that`这些内存段。

![](../../../../../../img/Pasted%20image%2020250924221834.png)

`this Segment`存储当前对象的成员变量或字段的值，`that Segment`存储当前方法可能正在处理的数组的值。因此，基本上，虚拟机设计了这四个段，就是为了在 **虚拟机层面** 保留并体现现实语言运行时的数据含义（语义）。

那我们如何实现这四个内存段呢？

首先，我们需要记住的是，从概念上说，我们使用它们的方式完全相同。我们需要`push/pop`、`segments`、`index`，除此之外我们不需要任何东西，因此可以统一访问它们，同样，我们也可以用完全相同的方式实现它们。