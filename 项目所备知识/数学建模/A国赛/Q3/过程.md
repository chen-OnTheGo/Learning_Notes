
## 1.数据准备

- 每位孕妇（`孕妇代码`）有多次检测 → 纵向重复测量
- 核心目标：预测 Y 染色体浓度随孕周的变化
- 核心变量：年龄、体重、原始读段数、重复读段的比例、18号染色体的Z值、检测孕周（周）、Y染色体的Z值、X染色体浓度、被过滤掉读段数的比例（都为数值变量）

**操作**：

1. **筛选男胎样本**中，根据问题一得出的显著变量：
	**负向影响**：`age (-0.0008)`, `weight (-0.0006)`, `total_reads (-4.25e-09)`, `mapping_rate (-0.1245)`, `z_18 (-0.0038)`
    
	**正向影响**：`gestational_week (0.0005)`, `z_y (0.0043)`, `x_concentration (0.4021)`, `filter_rate (0.7690)`

为：年龄、体重、原始读段数、重复读段的比例、18号染色体的Z值、检测孕周（周）、Y染色体的Z值、X染色体浓度、被过滤掉读段数的比例

1. **时间变量处理**：`检测孕周（周）` 已经是浮点型，直接作为纵向时间指标
2. **自变量标准化**：BMI、年龄、体重、z值等可做标准化，避免量纲差异


## 2. 模型选择：纵向混合效应模型

![](../../../../img/Pasted%20image%2020250906110654.png)

实现：使用 **`statsmodels`** 的 `MixedLM` 来建模

`statsmodels` 的 `MixedLM` 是 **混合线性模型（Mixed Linear Model）** 的实现。它用来分析 **纵向数据（重复测量数据）或群组嵌套数据**，同时考虑 **固定效应** 和 **随机效应**。
##### **概念解释**
1. **固定效应（Fixed Effects）**
    - 就像普通线性回归的系数一样，反映整体趋势。
    - 把这些变量当作整体趋势的解释变量（固定效应），相当于普通回归里的自变量。
    - 例子：BMI、孕周、年龄、身高、体重、z_y、IVF妊娠等对 Y 染色体浓度的平均影响。
2. **随机效应（Random Effects）**
    - 用来捕捉 **个体差异** 或 **群组差异**。
    - 例子：同一孕妇的多次检测，孕妇之间可能有不同的基线 Y 染色体浓度（随机截距）和不同的随孕周变化趋势（随机斜率）。
3. **残差（Residuals）**
    - 模拟测序误差或观测噪声。

![](../../../../img/Pasted%20image%2020250906110830.png)
![](../../../../img/Pasted%20image%2020250906110843.png)

代码位于：

输出结果：
```
          Mixed Linear Model Regression Results
=========================================================
Model:              MixedLM Dependent Variable: Y染色体浓度
No. Observations:   1082    Method:             ML
No. Groups:         267     Scale:              0.0001
Min. group size:    1       Log-Likelihood:     2753.3873
Max. group size:    8       Converged:          Yes
Mean group size:    4.1
---------------------------------------------------------
               Coef.  Std.Err.   z    P>|z| [0.025 0.975]
---------------------------------------------------------
const           0.079    0.002 46.851 0.000  0.075  0.082
年龄             -0.002    0.002 -1.400 0.162 -0.005  0.001
体重             -0.004    0.001 -2.772 0.006 -0.007 -0.001
原始读段数          -0.002    0.000 -4.944 0.000 -0.003 -0.001
重复读段的比例        -0.000    0.000 -0.603 0.546 -0.001  0.001       
18号染色体的Z值      -0.002    0.001 -3.219 0.001 -0.003 -0.001        
检测孕周（周）         0.012    0.001 14.235 0.000  0.010  0.014       
Y染色体的Z值         0.001    0.001  1.082 0.279 -0.001  0.002
X染色体浓度          0.009    0.001 15.133 0.000  0.008  0.010
被过滤掉读段数的比例      0.002    0.000  3.641 0.000  0.001  0.003    
const Var       0.001    0.019
const x 孕周 Cov -0.000    0.001
孕周 Var          0.000    0.000
========================================================
```

结果分析：
	基本信息：
- **Dependent Variable**: `Y染色体浓度` → 模型预测的目标变量
- **No. Observations**: 1082 → 总共 1082 次测量
- **No. Groups**: 267 → 共有 267 位孕妇（每位孕妇是一个随机效应组）
- **Min/Max/Mean group size**: 每位孕妇测量次数最少 1 次，最多 8 次，平均 4.1 次
- **Converged**: Yes → 模型拟合收敛，结果可靠

- **Coef.（系数）**：每个固定效应变量对目标变量（这里是 `Y染色体浓度`）的平均影响。例如 `检测孕周（周）` 的系数 0.012 → 孕周每增加 1 个标准差，Y 染色体浓度平均增加 0.012 个单位（注意你之前对数值变量做了标准化）。
    
- **Std.Err.（标准误）**：系数的估计误差，用于衡量系数估计的稳定性。
    
- **z 值**：系数除以标准误 → 用来检验系数是否显著不为 0。
    
- **P>|z|**：系数的显著性水平，小于 0.05 通常认为显著。
    
- **[0.025 0.975]**：系数 95% 置信区间。

	固定效应（Coef）
	固定效应反映 **整体趋势**，也就是对所有孕妇的平均影响例如孕周、体重、X染色体浓度等对 Y 染色体浓度的平均影响。：

| 变量         | Coef.  | P>    | z                            |     | 解释  |     |
| ---------- | ------ | ----- | ---------------------------- | --- | --- | --- |
| const      | 0.079  | 0.000 | 截距，Y染色体浓度的基准值                |     |     |     |
| 年龄         | -0.002 | 0.162 | 年龄对 Y 染色体浓度影响不显著             |     |     |     |
| 体重         | -0.004 | 0.006 | 体重增加 → Y染色体浓度略下降，显著          |     |     |     |
| 原始读段数      | -0.002 | 0.000 | 测序读段数越多 → 浓度略下降，显著           |     |     |     |
| 重复读段比例     | -0.000 | 0.546 | 不显著                          |     |     |     |
| 18号染色体 Z 值 | -0.002 | 0.001 | 与 Y 染色体浓度负相关，显著              |     |     |     |
| 检测孕周       | 0.012  | 0.000 | 随孕周增加 → Y染色体浓度升高，显著          |     |     |     |
| Y染色体 Z值    | 0.001  | 0.279 | 不显著                          |     |     |     |
| X染色体浓度     | 0.009  | 0.000 | X染色体浓度越高 → Y染色体浓度升高，显著       |     |     |     |
| 被过滤掉读段数比例  | 0.002  | 0.000 | 测序质量低（被过滤读段高） → Y染色体浓度略升高，显著 |     |     |     |

💡 可以看出，**孕周、体重、X染色体浓度和测序指标**是影响 Y染色体浓度的重要因素。

	随机效应：
- **const Var**: 0.001 → 每位孕妇的随机截距方差，表示个体之间基线差异
    
- **孕周 Var**: 0.000 → 孕周随机斜率方差，每位孕妇随孕周变化的差异
    
- **const x 孕周 Cov**: -0.000 → 截距与孕周斜率的协方差
    

解释：每位孕妇的 Y染色体浓度随孕周变化的曲线都有个体差异，这些差异被随机效应捕捉了。

![](../../../../img/Pasted%20image%2020250906120001.png)


你的这段代码核心逻辑就是：

**① 建立混合效应模型**

- 固定效应：年龄、体重、孕周、Z值等整体趋势因素。
    
- 随机效应：孕妇个体的随机截距 + 孕周斜率，反映个体差异。
    
- 模型估计出整体规律 + 每个孕妇的个体偏差。
    

**② 做“达标孕周预测”**

- 先设置一个孕周范围 `pred_weeks`（比如 11 周到 20 周）。
    
- 把每位孕妇的平均年龄、体重等代入，生成预测矩阵 `X`。
    
- 固定效应部分：用系数 * 自变量 得到预测浓度。
    
- 随机效应部分：加上该孕妇的个体偏差（截距和孕周斜率修正）。
    
- 得到预测的 Y 染色体浓度曲线 `y_pred`。
    

**③ 加入不确定性（蒙特卡罗模拟）**

- 模拟测序误差：在 `y_pred` 上加一个正态噪声（标准差取自残差）。
    
- 每次模拟找“第一次浓度 ≥ 4% 的孕周”。
    
- 重复 1000 次，得到一组模拟的达标孕周。
    

**④ 输出和可视化**

- 对每位孕妇，保存：平均达标孕周 + 达标孕周的分布（1000 次结果）。
    
- `df_results` 就是结果表。
    
- 最后画直方图：展示某个孕妇达标孕周的概率分布。
    

👉 直观理解：  
你相当于在问：  
“假设测序有噪声，这个孕妇 Y 染色体浓度第一次 ≥ 4% 的孕周是多少？如果重复做 1000 次实验，她大概率会在哪个孕周达标？”

这样就能：

- 个体化（不同孕妇的曲线不同）
    
- 不确定性（模拟误差影响）
    
- 统计总结（均值 + 分布）

![](../../../../img/Pasted%20image%2020250906144945.png)


## 合理分组

**层次聚类（hierarchical clustering）** 来对孕妇进行分组。

![](../../../../img/Pasted%20image%2020250906153419.png)


## 确定最佳时点

![](../../../../img/Pasted%20image%2020250906154535.png)
### 分析思路

- **每组最佳 NIPT 时点**：基于蒙特卡罗模拟，选择达标概率达到 0.95 的最早孕周。
    
- **测序误差影响**：
    
    - 增大残差（测序误差）会**推迟最佳孕周**。
        
    - 减小残差会**提前最佳孕周**。
        
- **风险最小化**：
    
    - 最佳 NIPT 时点越早，孕妇潜在风险越小（早期发现异常）。
        
    - 结合达标概率与残差敏感性，可给出**最佳孕周范围**而非单点。
![](../../../../img/Pasted%20image%2020250906154756.png)

每组最佳 NIPT 孕周（达标概率 >= 95%）：
组 1: 17.29 周
组 2: 12.11 周
组 3: 11.41 周
组 4: 11.41 周
组 5: 15.78 周
组 6: 12.11 周
测序误差敏感性分析结果：
sigma factor 0.5: {1: 17.236180904522612, 2: 12.110552763819095, 3: 11.407035175879397, 4: 11.407035175879397, 5: 15.77889447236181, 6: 12.160804020100503}
sigma factor 1.0: {1: 17.236180904522612, 2: 12.110552763819095, 3: 11.407035175879397, 4: 11.407035175879397, 5: 15.829145728643216, 6: 12.160804020100503}
sigma factor 1.5: {1: 17.236180904522612, 2: 12.110552763819095, 3: 11.457286432160805, 4: 11.407035175879397, 5: 15.829145728643216, 6: 12.160804020100503}


![](../../../../img/Pasted%20image%2020250906154931.png)
![](../../../../img/Pasted%20image%2020250906154941.png)
**结论：**

1. 大部分孕妇群体的最佳 NIPT 孕周相对稳健，不受常见测序误差影响。
    
2. 个别群体（达标概率波动大或孕周分布宽的群体）对测序误差更敏感，需要稍晚的孕周以保证 ≥95% 的达标概率。
    
3. 在实际应用中，可根据孕妇的分组特征灵活安排 NIPT 时间，同时考虑潜在测序误差带来的微小调整。
