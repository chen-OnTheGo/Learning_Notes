无创产前检测 （NIPT）：诊断方式的局限性：https://www.degruyterbrill.com/document/doi/10.1515/dx-2015-0002/html

https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0298643

`>=` 35岁就为高龄产妇

https://gocm.bmj.com/content/5/1/e000187

画图：
聚类树（用于Kmeans等聚类方法）、PDP、Q-Q图
## 问题一

强调女胎Y染色体浓度为0
#### 数据预处理

1. 女胎中GC值过低，低于40%，删除数据。
2. 统一规范，对于格式不一的，例如“末次月经”的年份表达，一种为"2021-11-08"一种为"2021/11/30"，统一格式为
3. 统一量纲（周）

输出结果：
```
男胎样本数：1082
['序号', '孕妇代码', '年龄', '身高', '体重', '末次月经', 'IVF妊娠', '检测日期', '检测抽血次数', '检测孕周', '孕妇BMI', '原始读段数', '在参考基因组上比对的比例', '重复读段的比例', '唯一比对的读段数  ', 'GC含量', '13号染色体的Z值', '18号染色体的Z值', '21号染色体的Z值', 'X染色体的Z值', 'Y染色体的Z值', 'Y染色体浓度', 'X染色体浓度', '13号染色体的GC含量', '18号染色体的GC含量', '21号染色体的GC含量', '被过滤掉读段数的比例', '染色 体的非整倍体', '怀孕次数', '生产次数', '胎儿是否健康', '检测孕周2']    
清理后样本数：1081

连续变量相关性分析：
            Variable  Correlation       p-value    Method  significant 
18   x_concentration     0.474893  6.719585e-62  Spearman         True 
14              z_18    -0.177930  3.853143e-09  Spearman         True 
2             weight    -0.166269  3.826116e-08  Spearman         True 
6       mapping_rate    -0.159684  1.305925e-07  Spearman         True 
4                bmi    -0.154317  3.424704e-07  Spearman         True 
0                age    -0.117184  1.126071e-04  Spearman         True 
17               z_y     0.112689  2.051490e-04  Spearman         True 
7     duplicate_rate     0.105590  5.064086e-04  Spearman         True 
1             height    -0.100719  9.127845e-04  Spearman         True 
5        total_reads    -0.087010  4.197851e-03  Spearman         True 
19       filter_rate     0.085267  5.026597e-03  Spearman         True 
3   gestational_week     0.084529  5.419647e-03  Spearman         True 
13              z_13    -0.077386  1.092128e-02  Spearman         True 
8       unique_reads    -0.070434  2.055966e-02  Spearman         True 
16               z_x    -0.056603  6.283526e-02  Spearman        False 
11             gc_18    -0.050018  1.002515e-01  Spearman        False 
10             gc_13    -0.037508  2.178707e-01  Spearman        False 
15              z_21     0.033047  2.776625e-01  Spearman        False 
9   gc_content_total    -0.016780  5.815586e-01  Spearman        False 
12             gc_21    -0.010991  7.181251e-01  Spearman        False 

分类变量显著性检验：
          Variable   p-value Method  significant
0              ivf  0.023808  ANOVA         True
1  pregnancy_times  0.235838  ANOVA        False
2      birth_times  0.323713  ANOVA        False

显著相关的连续变量：['age', 'height', 'weight', 'gestational_week', 'bmi', 'total_reads', 'mapping_rate', 'duplicate_rate', 'unique_reads', 'z_13', 'z_18', 'z_y', 'x_concentration', 'filter_rate']
显著相关的分类变量：['ivf']
Lasso输入样本数：1081

Lasso筛选后保留的变量：['age', 'height', 'weight', 'gestational_week', 'total_reads', 'mapping_rate', 'duplicate_rate', 'z_13', 'z_18', 'z_y', 'x_concentration', 'filter_rate', 'ivf_IVF（试管婴儿）', 'ivf_自然受孕']
Lasso系数：
age                -0.003047
height              0.000744
weight             -0.005514
gestational_week    0.002104
total_reads        -0.003975
mapping_rate       -0.001847
duplicate_rate      0.001405
z_13                0.000673
z_18               -0.004843
z_y                 0.005544
x_concentration     0.016647
filter_rate         0.002569
ivf_IVF（试管婴儿）      -0.001982
ivf_自然受孕           -0.001633
dtype: float64
X_final 数据类型：
const               float64
age                 float64
height              float64
weight              float64
gestational_week    float64
total_reads         float64
mapping_rate        float64
duplicate_rate      float64
z_13                float64
z_18                float64
z_y                 float64
x_concentration     float64
filter_rate         float64
ivf_IVF（试管婴儿）       float64
ivf_自然受孕            float64
dtype: object

y 数据类型： float64

============================================================
多元线性回归结果
============================================================
                            OLS Regression Results                     

==============================================================================
Dep. Variable:        y_concentration   R-squared:                     
  0.370
Model:                            OLS   Adj. R-squared:                
  0.362
Method:                 Least Squares   F-statistic:                   
  44.75
Date:                Sat, 06 Sep 2025   Prob (F-statistic):           8.38e-97
Time:                        09:50:00   Log-Likelihood:                
 2387.0
No. Observations:                1081   AIC:                           
 -4744.
Df Residuals:                    1066   BIC:                           
 -4669.
Df Model:                          14                                  

Covariance Type:            nonrobust                                  

====================================================================================
                       coef    std err          t      P>|t|      [0.025      0.975]
------------------------------------------------------------------------------------
const                0.1920      0.058      3.317      0.001       0.078       0.306
age                 -0.0008      0.000     -3.712      0.000      -0.001      -0.000
height               0.0002      0.000      0.816      0.414      -0.000       0.001
weight              -0.0006      0.000     -5.287      0.000      -0.001      -0.000
gestational_week     0.0005      0.000      2.354      0.019     8.8e-05       0.001
total_reads      -4.249e-09   8.91e-10     -4.767      0.000      -6e-09    -2.5e-09
mapping_rate        -0.1245      0.057     -2.195      0.028      -0.236      -0.013
duplicate_rate       0.5249      0.305      1.720      0.086      -0.074       1.124
z_13                 0.0006      0.001      0.772      0.440      -0.001       0.002
z_18                -0.0038      0.001     -5.136      0.000      -0.005      -0.002
z_y                  0.0043      0.001      6.323      0.000       0.003       0.006
x_concentration      0.4021      0.021     18.806      0.000       0.360       0.444
filter_rate          0.7690      0.251      3.064      0.002       0.277       1.261
ivf_IVF（试管婴儿）       -0.0245      0.013     -1.863      0.063      -0.050       0.001
ivf_自然受孕            -0.0141      0.009     -1.556      0.120      -0.032       0.004
==============================================================================
Omnibus:                       62.796   Durbin-Watson:                 
  0.725
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              
 72.450
Skew:                           0.611   Prob(JB):                     1.85e-16
Kurtosis:                       3.340   Cond. No.                     1.82e+09
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[2] The condition number is large, 1.82e+09. This might indicate that there are
strong multicollinearity or other numerical problems.

方差膨胀因子（VIF）：
            Variable       VIF
0                age  1.041654
1             height  1.647928
2             weight  1.698914
3   gestational_week  1.262075
4        total_reads  1.076630
5       mapping_rate  1.084669
6     duplicate_rate  1.058968
7               z_13  1.355394
8               z_18  1.388867
9                z_y  1.174214
10   x_concentration  1.184452
11       filter_rate  1.098480
12     ivf_IVF（试管婴儿）  1.912525
13          ivf_自然受孕  1.908376

拟合度：
                            OLS Regression Results                     

==============================================================================
Dep. Variable:        y_concentration   R-squared:                     
  0.370
Model:                            OLS   Adj. R-squared:                
  0.362
Method:                 Least Squares   F-statistic:                   
  44.75
Date:                Sat, 06 Sep 2025   Prob (F-statistic):           8.38e-97
Time:                        09:50:00   Log-Likelihood:                
 2387.0
No. Observations:                1081   AIC:                           
 -4744.
Df Residuals:                    1066   BIC:                           
 -4669.
Df Model:                          14                                  

Covariance Type:            nonrobust                                  

====================================================================================
                       coef    std err          t      P>|t|      [0.025      0.975]
------------------------------------------------------------------------------------
const                0.1920      0.058      3.317      0.001       0.078       0.306
age                 -0.0008      0.000     -3.712      0.000      -0.001      -0.000
height               0.0002      0.000      0.816      0.414      -0.000       0.001
weight              -0.0006      0.000     -5.287      0.000      -0.001      -0.000
gestational_week     0.0005      0.000      2.354      0.019     8.8e-05       0.001
total_reads      -4.249e-09   8.91e-10     -4.767      0.000      -6e-09    -2.5e-09
mapping_rate        -0.1245      0.057     -2.195      0.028      -0.236      -0.013
duplicate_rate       0.5249      0.305      1.720      0.086      -0.074       1.124
z_13                 0.0006      0.001      0.772      0.440      -0.001       0.002
z_18                -0.0038      0.001     -5.136      0.000      -0.005      -0.002
z_y                  0.0043      0.001      6.323      0.000       0.003       0.006
x_concentration      0.4021      0.021     18.806      0.000       0.360       0.444
filter_rate          0.7690      0.251      3.064      0.002       0.277       1.261
ivf_IVF（试管婴儿）       -0.0245      0.013     -1.863      0.063      -0.050       0.001
ivf_自然受孕            -0.0141      0.009     -1.556      0.120      -0.032       0.004
==============================================================================
Omnibus:                       62.796   Durbin-Watson:                 
  0.725
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              
 72.450
Skew:                           0.611   Prob(JB):                     1.85e-16
Kurtosis:                       3.340   Cond. No.                     1.82e+09
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
[2] The condition number is large, 1.82e+09. This might indicate that there are
strong multicollinearity or other numerical problems.
```

## 问题二

第二问需要对男胎中Y染色体浓度低于4%的数据进行删除，因为难以保证结果的准确性，为了避免误导。

检测误差是什么意思
1. 染色体的非整倍体不为空，但生出来的胎儿是健康的。这就是误差？

2. 早于最佳时间点检测对于结果的影响？
3. ![](../../../img/85426b757eb83e20dcc844986daf197b%201.png)


4. 根据“染色体的非整倍体”的结果和“胎儿是否健康”的结果，提取出假阳性和假阴性的数据，再统计这些数据的共同点，例如：GC值偏低，BMI，Y染色体浓度，孕检周期。

解法：JB检验（是否正态分布）-> 蒙特卡洛
### BMI分组

根据中国的标准。记得讲述这个标准的合理性。


## 问题三

问题3里，把影响达标时间的多因素一起建模：用 Cox 比例风险模型或加速失效时间（AFT）模型，协变量包含 BMI、年龄、身高、体重（或直接用 BMI 与身高、体重别共线性诊断后取舍）、测序质控项；若有重复抽血，加入聚类稳健方差或随机效应（共享脆弱性）。得到模型后，对不同 BMI 组（沿用问题2的最佳分组或经模型选优的分组），计算在各孕周的达标概率曲线 S^(t)\hat{S}(t)S^(t) 或 F^(t)\hat{F}(t)F^(t)，并把测量误差通过“观测门限不确定性”折算为观测达标概率，再用同样的期望风险准则选出各 BMI 组的最佳 NIPT 周数；同时给出灵敏度分析：改变误差方差、读段数（影响检测精度）或门限（如 3.5%–4.5%）时，最佳时点的稳定性如何。



## 问题四



问题4里只看女胎（无 Y），目标是判定 21/18/13 非整倍体。以“是否非整倍体”为因变量，特征包含 21/18/13/X 的 Z 值、全基因组及目标染色体 GC 含量、读段相关质控指标（原始读段、唯一比对比例、重复率、过滤比例）、孕周与 BMI 等。先进行严格的样本质控和 GC 偏倚校正，再建二分类模型：首选可解释的惩罚逻辑回归（L1/L2 或弹性网），也可备选梯度提升树/随机森林作对比；对类别极不平衡要用加权损失或阈值移动，并以高灵敏度优先（临床上宁肯多复检也别漏检）。用分层交叉验证评估 AUC、灵敏度、特异度、PPV/NPV 与校准曲线，选择阈值时结合人群患病率与复检成本设定决策曲线。最终给出一个可操作的判定流程：先质控阈值（如唯一比对读段数、重复率、测序深度、预计胎儿分数 proxy），再通过校准后的模型输出风险分数，超过高风险阈值判阳性、灰区建议复检或侵入性确证、低于低风险阈值判阴性，并附带基于质控的“不报告/建议重采”条件。


你提到的方法本质上是在 **NIPT 女胎非整倍体检测**中，把统计学建模和临床安全结合起来，理由可以从 **生物学、技术和临床风险管理**三方面理解：

1. **只看女胎、无 Y 染色体**
    

- 男胎可以通过 Y 染色体直接估计胎儿 DNA fraction，但女胎没有 Y，**只能依赖 Z 值和测序读段分布**。
    
- 因此需要更多特征（21/18/13/X 染色体 Z 值、GC 含量、读段质控指标、孕周、BMI 等）来补偿信息不足的情况。
    

2. **严格质控和 GC 校正**
    

- 测序存在噪声（重复 reads、低比对率、GC 偏倚等）会影响 Z 值准确性。
    
- 严格质控和校正可以保证 **输入模型的数据更可靠**，减少假阳性或假阴性。
    

3. **可解释的惩罚逻辑回归（L1/L2/弹性网）优先**
    

- 临床上 **需要可解释性**：医生希望知道哪些特征导致判定高风险，而不是黑箱模型。
    
- 惩罚项可以处理特征多、相关性强的情况，同时避免过拟合。
    

4. **梯度提升树/随机森林作对比**
    

- 提供对非线性关系或复杂特征交互的补充检查。
    
- 如果结果一致，可以增强模型可靠性；如果不一致，提示进一步分析。
    

5. **类别不平衡处理**
    

- 女胎非整倍体比例非常低，直接训练会导致模型倾向判阴性。
    
- 用加权损失或阈值移动可以让模型更关注 **灵敏度**（避免漏检），符合临床“宁可多复检也别漏检”的原则。
    

6. **分层交叉验证和评估指标**
    

- AUC、灵敏度、特异度、PPV/NPV 与校准曲线能全面评估模型性能。
    
- 阈值选择结合人群患病率和复检成本，可以实现 **风险最小化的临床决策**。
    

7. **可操作的判定流程**
    

- 先质控（保证测序数据可靠），再预测风险，输出高/低/灰区判定：
    
    - 高风险 → 阳性提示，可能需要侵入性确诊
        
    - 灰区 → 建议复检
        
    - 低风险 → 阴性
        
- 这样做可以 **平衡检测准确性与临床安全性**，同时提供可执行的操作指南，降低漏检风险和不必要的复检/侵入性操作。
    

✅ 总结：  
这种流程是 **数据驱动 + 临床安全结合的策略**，目的就是在女胎非整倍体检测中，**在极低患病率和测序噪声存在的情况下，提高灵敏度、可解释性和可靠性，同时给出明确操作建议**。


### 要算FF吗

得到 **胎儿 DNA fraction (FF)** 在 NIPT 中非常关键，因为它直接影响检测的 **准确性和可靠性**，具体作用包括：

1. **判断样本是否可报告（reportable）**
    

- FF 太低（通常单胎 <4%，双胎 <8%）时，胎儿 DNA 信号太弱，Z 值和非整倍体检测可能不稳定。
    
- 低 FF 的样本可能被标记为“不可报告”或建议复采血。
    

2. **影响非整倍体检测灵敏度和特异度**
    

- FF 越高，目标染色体的 reads 占比越明显，Z 值越可靠。
    
- FF 太低可能出现假阴性（漏检）或假阳性（误报）。
    

3. **男胎可以直接估计胎儿 DNA 分数**
    

- Y 染色体 reads 占比可以直接反映胎儿 DNA 含量，这对于判断检测时间（孕周）和测序深度是否足够非常重要。
    

4. **决定最佳检测时点**
    

- 通过 FF 随孕周变化的趋势，可以推荐最佳 NIPT 时点（例如男胎孕妇 BMI 不同，达到 4% FF 的孕周也不同）。
    

5. **可用于质控和数据校正**
    

- FF 信息可以在分析中对 Z 值、GC 校正、非整倍体概率等进行加权或校正，提高模型稳定性。
    

6. **风险评估和临床决策**
    

- 如果 FF 过低，即使 Z 值提示高风险，也可能先建议复采血而不是直接进行侵入性确诊，从而降低临床风险。

![](../../../img/Pasted%20image%2020250905090125.png)

![](../../../img/Pasted%20image%2020250905090139.png)

![](../../../img/Pasted%20image%2020250905090149.png)


#### 数据预处理

对女胎中GC值小于39%的进行去除。去掉末次月经。统一检测孕周为以“周”为单位。NumberofPregnanties为3表示大于等于三，这是分类变量

分别使用RUSBoost和随机森林，根据各个指标来分别预测三种染色体是否异常，若预测结果理想，则反推出模型的分类依据，进而得出重要的预测指标，即女胎异常的判定方法（在模型预测效果理想的前提下，进一步分析模型的分类规则，以识别主要的预测特征，从而总结女胎异常的判定方法。”）